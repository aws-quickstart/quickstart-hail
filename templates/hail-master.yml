AWSTemplateFormatVersion: "2010-09-09"
Description: "AWS Hail Quick Start (qs-1qp776mh2)"

Parameters:

  QSS3BucketName:
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    ConstraintDescription: "Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    Default: "aws-quickstart"
    Description: "The name of the Amazon S3 bucket name for the Quick Start assets. Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    Type: "String"

  QSS3KeyPrefix:
    AllowedPattern: "^[0-9a-zA-Z-/]*$"
    ConstraintDescription: "Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Default: "quickstart-hail/"
    Description: "S3 key prefix for the Quick Start assets. Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Type: "String"

  pKmsEbsArn:
    Description: "(Optional) If region level EBS encryption is enabled specify the full key ARN."
    Default: ""
    Type: "String"

  pHailBucket:
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    Description: "Ignored if auto creating the Hail bucket. Name of the Amazon S3 bucket where EMR logs, cluster manifests, and VEP configuration files are placed."
    Type: "String"

  pCreateHailBucket:
    Type: "String"
    Description: "Choose no to use an existing bucket."
    AllowedValues:
      - "yes"
      - "no"
    Default: "yes"

  pSageMakerBucket:
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    Description: "Ignored if auto creating the SageMaker bucket. The name of the Amazon S3 bucket for common notebooks and SageMaker home directory backups."
    Type: "String"

  pCreateSageMakerBucket:
    Type: "String"
    Description: "Choose no to use an existing bucket."
    AllowedValues:
      - "yes"
      - "no"
    Default: "yes"

  pTagEnvironment:
    AllowedValues:
      - "production"
      - "staging"
      - "development"
    Default: "development"
    Description: "Environment tag to associate with resources."
    Type: "String"

  pTagOwner:
    Type: "String"
    Description: "(Optional) Owner tag to associate with resources. Person/Department, etc."
    Default: ""

  pTargetVpc:
    Type: "String"
    Description: "Choosing new will create a new VPC."
    AllowedValues:
      - "new"
      - "existing"
    Default: "existing"

  pNewVpcCidr:
    Type: "String"
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Description: "Required for new VPC creation - A /16 address space for a new VPC."
    Default: "10.0.0.0/16"

  pVpcId:
    Description: "Required if using existing VPC. Ignored if creating a new VPC."
    Type: "String"
    Default: ""

  pSubnetId:
    Description: "Required if using existing VPC. Ignored if creating a new VPC. Target subnet for EMR Cluster and SageMaker Notebook instances."
    Type: "String"
    Default: ""

  pSubnetType:
    Description: "Choosing public will launch EMR resources with public IP addresses."
    Type: "String"
    AllowedValues:
      - "public"
      - "private"
    Default: "private"

Metadata:

  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Network settings"
        Parameters:
          - "pTargetVpc"
          - "pNewVpcCidr"
          - "pVpcId"
          - "pSubnetId"
          - "pSubnetType"
      - Label:
          default: "Hail settings"
        Parameters:
          - "pCreateSageMakerBucket"
          - "pCreateHailBucket"
          - "pHailBucket"
          - "pSageMakerBucket"
          - "pKmsEbsArn"
      - Label:
          default: "Tagging"
        Parameters:
          - "pTagEnvironment"
          - "pTagOwner"
      - Label:
          default: "AWS Quick Start configuration"
        Parameters:
         - "QSS3BucketName"
         - "QSS3KeyPrefix"
    ParameterLabels:
      QSS3BucketName:
        default: Quick Start S3 bucket name
      QSS3KeyPrefix:
        default: Quick Start S3 key prefix
      pKmsEbsArn:
        default: "KMS Key ARN for EBS volume encryption"
      pHailBucket:
        default: "Amazon S3 bucket name for Hail artifacts"
      pCreateHailBucket:
        default: "Auto create Hail bucket"
      pSageMakerBucket:
        default: "Amazon S3 bucket name for SageMaker backup"
      pCreateSageMakerBucket:
        default: "Auto create backup bucket for SageMaker"
      pTagOwner:
        default: "Owner tag"
      pTagEnvironment:
        default: "Environment tag"
      pTargetVpc:
        default: "Target VPC"
      pNewVpcCidr:
        default: "CIDR range for new VPC"
      pVpcId:
        default: "VPC ID for existing VPC"
      pSubnetId:
        default: "Subnet ID for existing VPC"
      pSubnetType:
        default: "Subnet type"

Conditions:

    createVpc: !Equals [!Ref pTargetVpc, "new"]

Resources:

  core:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL: !Sub "https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}templates/hail-core.yml"
      Parameters:
        pHailBucket: !Ref pHailBucket
        pCreateHailBucket: !Ref pCreateHailBucket
        pKmsEbsArn: !Ref pKmsEbsArn
        pSageMakerBucket: !Ref pSageMakerBucket
        pCreateSageMakerBucket: !Ref pCreateSageMakerBucket
        pSubnetId: !If [createVpc, !GetAtt 'vpc.Outputs.PrivateSubnet1AID', !Ref pSubnetId]
        pSubnetType: !If [createVpc, "private", !Ref pSubnetType]
        pTagEnvironment: !Ref pTagEnvironment
        pTagOwner: !Ref pTagOwner
        pVpcId: !If [createVpc, !GetAtt 'vpc.Outputs.VPCID', !Ref pVpcId]
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
      TimeoutInMinutes: 5

  vpc:
    Type: "AWS::CloudFormation::Stack"
    Condition: createVpc
    Properties:
      TemplateURL: !Sub "https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}submodules/quickstart-aws-vpc/templates/aws-vpc.template"
      Parameters:
        AvailabilityZones: !Join
        - ','
        - - !Select
            - 0
            - Fn::GetAZs: !Ref 'AWS::Region'
          - !Select
            - 1
            - Fn::GetAZs: !Ref 'AWS::Region'
        VPCCIDR: !Ref pNewVpcCidr
        PublicSubnet1CIDR: !Select [ 0, !Cidr [ !Ref pNewVpcCidr, 6, 12 ]]
        PrivateSubnet1ACIDR: !Select [ 1, !Cidr [ !Ref pNewVpcCidr, 6, 12 ]]
        PrivateSubnet1BCIDR: !Select [ 2, !Cidr [ !Ref pNewVpcCidr, 6, 12 ]]
        PublicSubnet2CIDR: !Select [ 3, !Cidr [ !Ref pNewVpcCidr, 6, 12 ]]
        PrivateSubnet2ACIDR: !Select [ 4, !Cidr [ !Ref pNewVpcCidr, 6, 12 ]]
        PrivateSubnet2BCIDR: !Select [ 5, !Cidr [ !Ref pNewVpcCidr, 6, 12 ]]
      TimeoutInMinutes: 10

Outputs:

  portfolio:
    Description: "Service Catalog Portfolio"
    Value: !GetAtt core.Outputs.portfolio

  codeBuildConsole:
    Description: "CodeBuild Project Console URL"
    Value: !Sub "https://console.aws.amazon.com/codesuite/codebuild/projects?region=${AWS::Region}"

  bucketHail:
    Description: "Hail S3 Bucket"
    Value: !GetAtt core.Outputs.bucketHail

  bucketSageMaker:
    Description: "SageMaker S3 Bucket"
    Value: !GetAtt core.Outputs.bucketSageMaker
